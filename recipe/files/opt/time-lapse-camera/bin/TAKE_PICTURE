#!/bin/bash -e
####################################
# TAKE_PICTURE
#
####################################

if [ "$IMAGE_RESOLUTION" = "" ]; then
  echo "Specify IMAGE_RESOLUTION."
  exit 1
fi

if [ "$IMAGE_DIRECTORY" = "" ]; then
  echo "Specify IMAGE_DIRECTORY."
  exit 1
fi

if [ "$VIDEO_DEVICES" = "" ]; then
  echo "Specify VIDEO_DEVICES."
  exit 1
fi

if [ ! -d "$IMAGE_DIRECTORY" ]; then
  mkdir -p $IMAGE_DIRECTORY
fi

tmp=/tmp/$$

touch $tmp-lock


OIFS="$IFS"
IFS=':'
set -- $VIDEO_DEVICES
IFS="$OIFS"
while [ "$1" != "" ]
do
  dev="$1"
  shift
  if [ ! -e "$dev" ]; then
    continue
  fi
  dev_label=$(echo $dev | sed 's|^/||;s|/|-|g')
  if [ ! -d "$IMAGE_DIRECTORY/$dev_label" ]; then
    mkdir -p "$IMAGE_DIRECTORY/$dev_label"
  fi
  ts=$(date +"%Y%m%d%H%M%S")
  fswebcam -d $dev -r $IMAGE_RESOLUTION $tmp-image
  cp $tmp-image $IMAGE_DIRECTORY/${dev_label}/img-${ts}.jpg
done

rm $tmp-*
