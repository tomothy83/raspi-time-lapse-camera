#!/bin/bash
####################################
# GENERATE_TIME_LAPSE
#
####################################

if [ "$PROCESS_SPOOL_DIRECTORY" = "" ]; then
  echo "Specify PROCESS_SPOOL_DIRECTORY."
  exit 1
fi

if [ "$S3_BUCKET" = "" ]; then
  echo "Specify S3_BUCKET."
  exit 1
fi

if [ "$AWS_ACCESS_KEY_ID" = "" ]; then
  echo "Specify AWS_ACCESS_KEY_ID."
  exit 1
fi

if [ "$AWS_SECRET_ACCESS_KEY" = "" ]; then
  echo "Specify AWS_SECRET_ACCESS_KEY."
  exit 1
fi

if [ "$AWS_DEFAULT_REGION" = "" ]; then
  echo "Specify AWS_DEFAULT_REGION."
  exit 1
fi

if [ ! -d "$PROCESS_SPOOL_DIRECTORY" ]; then
  echo "PROCESS_SPOOL_DIRECTORY does not exist."
  exit 1
fi

if [ "$VIDEO_DEVICES" = "" ]; then
  echo "Specify VIDEO_DEVICES."
  exit 1
fi

if [ "$1" = "" ]; then
  dt=$(date -d "-1 day" +"%Y%m%d")
else
  dt=$1
fi

tmp=/tmp/$$

touch $tmp-lock

OIFS="$IFS"
IFS=':'
set -- $VIDEO_DEVICES
IFS="$OIFS"
while [ "$1" != "" ]
do
  dev="$1"
  shift
  dev_label=$(echo $dev | sed 's|^/||;s|/|-|g')
  process_file_base=image-${dev_label}-$dt
  ffmpeg -f image2                                            \
    -framerate 30                                             \
    -pattern_type glob                                        \
    -i "$PROCESS_SPOOL_DIRECTORY/$process_file_base-*.jpg"    \
    -r 30                                                     \
    $tmp-${dev_label}-timelapse.avi

  if [ $? -ne 0 ]; then
    echo "ffmpeg error"
    continue
  fi

  aws s3 cp $tmp-timelapse.avi s3://$S3_BUCKET/upload/video/${dev_label}/$dt.avi

  if [ $? -ne 0 ]; then
    echo "uploading error"
    continue
  fi

  rm $PROCESS_SPOOL_DIRECTORY/$process_file_base-*
done

rm $tmp-*
